// This name is displayed on the configuration title card.
var watch_name = "%(watchName)s";
var show_chrono_dial = %(showChronoDial)s;
var enable_sweep_seconds = %(enableSweepSeconds)s;
var enable_show_day = %(showDayCard)s;
var enable_show_date = %(showDateCard)s;

// Define the initial config default values.  These defaults are used
// only if the Pebble is connected to the phone at the time of launch;
// otherwise, the defaults in init_default_options() are used instead.
var default_keep_battery_gauge = %(defaultBattery)s;
var default_keep_bluetooth_indicator = %(defaultBluetooth)s;
var default_second_hand = %(showSecondHand)s;
var default_hour_buzzer = %(enableHourBuzzer)s;
var default_draw_mode = 0;
var default_chrono_dial = 1;
var default_sweep_seconds = 0;
var default_show_day = %(defaultDayCard)s;
var default_show_date = %(defaultDateCard)s;
var default_display_lang = 'en_US';

var keep_battery_gauge;
var keep_bluetooth_indicator;
var second_hand;
var hour_buzzer;
var draw_mode;
var chrono_dial;
var sweep_seconds;
var show_day;
var show_date;
var display_lang;

var logLocalStorage = function() {
    var keys = Object.keys(localStorage);
    console.log("  localStorage = {");
    for (var key in keys) {
	console.log('      "' + keys[key] + '" : ' + localStorage[keys[key]] + ',');
    }
    console.log("  }");
}

var initialized = false;
var initialize = function() {
    console.log("initialize: " + initialized);
    if (initialized) {
	return;
    }

    logLocalStorage();

    keep_battery_gauge = localStorage.getItem(watch_name + ":keep_battery_gauge");
    if (!keep_battery_gauge) {
	keep_battery_gauge = default_keep_battery_gauge;
    }
    keep_battery_gauge = parseInt(keep_battery_gauge);
    
    keep_bluetooth_indicator = localStorage.getItem(watch_name + ":keep_bluetooth_indicator");
    if (!keep_bluetooth_indicator) {
	keep_bluetooth_indicator = default_keep_battery_gauge;
    }
    keep_bluetooth_indicator = parseInt(keep_bluetooth_indicator);

    second_hand = localStorage.getItem(watch_name + ":second_hand");
    if (!second_hand) {
	second_hand = default_second_hand;
    }
    second_hand = parseInt(second_hand);

    hour_buzzer = localStorage.getItem(watch_name + ":hour_buzzer");
    if (!hour_buzzer) {
	hour_buzzer = default_hour_buzzer;
    }
    hour_buzzer = parseInt(hour_buzzer);

    draw_mode = localStorage.getItem(watch_name + ":draw_mode");
    if (!draw_mode) {
	draw_mode = default_draw_mode;
    }
    draw_mode = parseInt(draw_mode);

    chrono_dial = localStorage.getItem(watch_name + ":chrono_dial");
    if (!chrono_dial) {
	chrono_dial = default_chrono_dial;
    }
    chrono_dial = parseInt(chrono_dial);

    sweep_seconds = localStorage.getItem(watch_name + ":sweep_seconds");
    if (!sweep_seconds) {
	sweep_seconds = default_sweep_seconds;
    }
    sweep_seconds = parseInt(sweep_seconds);

    show_day = localStorage.getItem(watch_name + ":show_day");
    if (!show_day) {
	show_day = default_show_day;
    }
    show_day = parseInt(show_day);

    show_date = localStorage.getItem(watch_name + ":show_date");
    if (!show_date) {
	show_date = default_show_date;
    }
    show_date = parseInt(show_date);

    display_lang = localStorage.getItem(watch_name + ":display_lang");
    if (!display_lang) {
	display_lang = default_display_lang;
    }

    console.log("   keep_battery_gauge: " + keep_battery_gauge);
    console.log("   keep_bluetooth_indicator: " + keep_bluetooth_indicator);
    console.log("   second_hand: " + second_hand);
    console.log("   hour_buzzer: " + hour_buzzer);
    console.log("   draw_mode: " + draw_mode);
    console.log("   chrono_dial: " + chrono_dial);
    console.log("   sweep_seconds: " + sweep_seconds);
    console.log("   show_day: " + show_day);
    console.log("   show_date: " + show_date);
    console.log("   display_lang: " + display_lang);

    // At startup, send the current configuration to the Pebble--the
    // phone storage keeps the authoritative state.  We delay by 1
    // second to give the Pebble a chance to set itself up for
    // receiving messages.
    setTimeout(function() {
	var configuration = {
	    'keep_battery_gauge' : keep_battery_gauge,
	    'keep_bluetooth_indicator' : keep_bluetooth_indicator,
	    'second_hand' : second_hand,
	    'hour_buzzer' : hour_buzzer,
	    'draw_mode' : draw_mode,
	    'chrono_dial' : chrono_dial,
	    'sweep_seconds' : sweep_seconds,
	    'show_day' : show_day,
	    'show_date' : show_date,
	    'display_lang' : display_lang,
	};
   	console.log("sending init config: " + JSON.stringify(configuration));
	Pebble.sendAppMessage(configuration);
    }, 1000)
}

Pebble.addEventListener("ready", function(e) {
    console.log("ready");
    initialize();
});

Pebble.addEventListener("showConfiguration", function(e) {
    console.log("showConfiguration starting");
    initialize();
    var url = "http://www.ddrose.com/pebble/rosewright_2_4_configure.html?watch_name=" + encodeURIComponent(watch_name) + "&keep_battery_gauge=" + keep_battery_gauge + "&keep_bluetooth_indicator=" + keep_bluetooth_indicator + "&second_hand=" + second_hand + "&hour_buzzer=" + hour_buzzer + "&draw_mode=" + draw_mode + "&display_lang=" + display_lang;
    if (show_chrono_dial) {
	url += "&chrono_dial=" + chrono_dial
    }
    if (enable_sweep_seconds) {
	url += "&sweep_seconds=" + sweep_seconds
    }
    if (enable_show_day) {
	url += "&show_day=" + show_day
    }
    if (enable_show_date) {
	url += "&show_date=" + show_date
    }
    console.log("showConfiguration: " + url);
    var result = Pebble.openURL(url);
    console.log("openURL result: " + result);
});

Pebble.addEventListener("webviewclosed", function(e) {
    console.log("Configuration window closed");
    console.log(e.type);
    console.log(e.response);

    if (e.response && e.response != 'CANCELLED') {
	var configuration = JSON.parse(e.response);
	console.log("sending runtime config: " + JSON.stringify(configuration));
	Pebble.sendAppMessage(configuration);
	
	keep_battery_gauge = configuration["keep_battery_gauge"];
	localStorage.setItem(watch_name + ":keep_battery_gauge", keep_battery_gauge);
	
	keep_bluetooth_indicator = configuration["keep_bluetooth_indicator"];
	localStorage.setItem(watch_name + ":keep_bluetooth_indicator", keep_bluetooth_indicator);
	
	second_hand = configuration["second_hand"];
	localStorage.setItem(watch_name + ":second_hand", second_hand);
	
	hour_buzzer = configuration["hour_buzzer"];
	localStorage.setItem(watch_name + ":hour_buzzer", hour_buzzer);
	
	draw_mode = configuration["draw_mode"];
	localStorage.setItem(watch_name + ":draw_mode", draw_mode);
	
	chrono_dial = configuration["chrono_dial"];
	localStorage.setItem(watch_name + ":chrono_dial", chrono_dial);
	
	sweep_seconds = configuration["sweep_seconds"];
	localStorage.setItem(watch_name + ":sweep_seconds", sweep_seconds);
	
	show_day = configuration["show_day"];
	localStorage.setItem(watch_name + ":show_day", show_day);

	show_date = configuration["show_date"];
	localStorage.setItem(watch_name + ":show_date", show_date);
	
	display_lang = configuration["display_lang"];
	localStorage.setItem(watch_name + ":display_lang", display_lang);

	logLocalStorage();
    }
});
